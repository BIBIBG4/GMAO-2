{% extends "base.html" %}
{% block title %}{{ entry.report.name }} - {{ entry.machine.name }}{% endblock %}
{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('machines') }}">Machines</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('machine_detail', machine_id=entry.machine.id) }}">{{ entry.machine.name }}</a></li>
    <li class="breadcrumb-item active" aria-current="page">Rapport du {{ entry.created_at.strftime("%d/%m/%Y %H:%M") }}</li>
  </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h2>{{ entry.report.name }}</h2>
    <p class="text-muted mb-0">
      {{ entry.machine.name }} ({{ entry.machine.code }}) ¬∑ {{ entry.created_at.strftime("%d/%m/%Y %H:%M") }}
      {% if entry.user %}
      ¬∑ Identifiant : {{ entry.user.username }}
      {% endif %}
      {% if entry.stock %}
      ¬∑ Stock : {{ entry.stock.name }} ({{ entry.stock.code }})
      {% endif %}
    </p>
  </div>
  <div class="btn-group">
  {% if current_user.user_type == 'admin' or (current_user.user_type == 'technicien' and entry.user_id == current_user.id) %}
  <a class="btn btn-outline-primary" href="{{ url_for('edit_maintenance_entry', entry_id=entry.id) }}" title="Modifier le rapport">‚úèÔ∏è</a>
  {% endif %}
    {% if current_user.user_type == 'admin' %}
    <form method="post" action="{{ url_for('delete_maintenance_entry', entry_id=entry.id) }}" class="d-inline" onsubmit="return confirm('√ätes-vous s√ªr de vouloir supprimer cette maintenance ? Cette action est irr√©versible et remettra les produits en stock.');">
      <button type="submit" class="btn btn-outline-danger" title="Supprimer">üóëÔ∏è</button>
    </form>
    {% endif %}
  </div>
</div>

{% if entry.machine.hour_counter_enabled %}
{% set unit = entry.machine.counter_unit or 'h' %}
<div class="card mb-3">
  <div class="card-body">
    <h5 class="card-title mb-3">Informations de compteur</h5>
    <div class="row g-3">
      <div class="col-md-6">
        <strong>Valeur du compteur √† l'instant de la maintenance :</strong><br>
        <span class="text-muted">{{ "%.1f"|format(entry.performed_hours) }} {{ unit }}</span>
      </div>
      {% if entry.hours_before_maintenance is not none %}
      <div class="col-md-6">
        <strong>Avant maintenance :</strong><br>
        <span class="text-muted">
          {% if entry.hours_before_maintenance < 0 %}
          <span class="text-danger">{{ "%.1f"|format(entry.hours_before_maintenance) }} {{ unit }} (retard)</span>
          {% elif entry.hours_before_maintenance == 0 %}
          <span class="text-danger">0 {{ unit }} (due)</span>
          {% else %}
          {{ "%.1f"|format(entry.hours_before_maintenance) }} {{ unit }}
          {% endif %}
        </span>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endif %}

<div class="list-group">
  {% for value in entry.values %}
  <div class="list-group-item">
    <div class="row g-2 align-items-center">
      <div class="col-md-3 col-lg-2">
        <strong>{{ value.component.label }}</strong>
      </div>
      <div class="col-md-2 col-lg-2">
        <span class="text-muted small">Type : {{ value.component.field_type }}</span>
      </div>
      <div class="col-md-7 col-lg-8">
        {% if value.component.field_type == "number" %}
        <span class="fw-normal">{{ value.value_number }}</span>
        {% elif value.component.field_type == "checkbox" %}
        {% if value.value_bool %}
        <span class="badge bg-success">Valid√©</span>
        {% else %}
        <span class="badge bg-secondary">Non valid√©</span>
        {% endif %}
        {% else %}
        <span class="fw-normal">{{ value.value_text }}</span>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

{% if movement and movement.items %}
<div class="card mt-3">
  <div class="card-body">
    <h5 class="card-title">
      <span>Produits utilis√©s</span>
    </h5>
    <div class="table-responsive">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Produit</th>
            <th>Code</th>
            <th>Quantit√©</th>
            <th class="text-end">Prix unitaire</th>
            <th class="text-end">Prix total</th>
          </tr>
        </thead>
        <tbody>
          {% set ns = namespace(total_price=0.0) %}
          {% for item in movement.items %}
          {% set line_total = item.product.price * item.quantity %}
          {% set ns.total_price = ns.total_price + line_total %}
          <tr>
            <td>{{ item.product.name }}</td>
            <td>{{ item.product.code }}</td>
            <td>{{ item.quantity }}</td>
            <td class="text-end">{{ "%.2f"|format(item.product.price) }} ‚Ç¨</td>
            <td class="text-end fw-bold">{{ "%.2f"|format(line_total) }} ‚Ç¨</td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th colspan="4" class="text-end">Total :</th>
            <th class="text-end">{{ "%.2f"|format(ns.total_price) }} ‚Ç¨</th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>
{% endif %}

{% if photos %}
<div class="card mt-3">
  <div class="card-body">
    <h5 class="card-title">Photos</h5>
    <div class="row g-3">
      {% for photo in photos %}
      <div class="col-md-4 col-lg-3">
        <div class="card">
          <a href="{{ url_for('view_maintenance_photo', photo_id=photo.id) }}" target="_blank">
            <img src="{{ url_for('view_maintenance_photo', photo_id=photo.id) }}" 
                 class="card-img-top" 
                 alt="{{ photo.original_filename }}"
                 style="height: 200px; object-fit: cover; cursor: pointer;" />
          </a>
          <div class="card-body p-2">
            <small class="text-muted d-block">{{ photo.original_filename }}</small>
            <small class="text-muted d-block">{{ photo.uploaded_at.strftime("%d/%m/%Y %H:%M") }}</small>
            {% if current_user.user_type == 'admin' or (current_user.user_type == 'technicien' and photo.user_id == current_user.id) %}
            <form method="post" action="{{ url_for('delete_maintenance_photo', photo_id=photo.id) }}" 
                  class="mt-2" 
                  onsubmit="return confirm('√ätes-vous s√ªr de vouloir supprimer cette photo ?');">
              <button type="submit" class="btn btn-sm btn-outline-danger">Supprimer</button>
            </form>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

