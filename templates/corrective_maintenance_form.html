{% extends "base.html" %}
{% block title %}{% if is_edit and maintenance %}Modifier{% else %}Nouvelle{% endif %} maintenances corrective - {{ machine.name }}{% endblock %}
{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('machines') }}">Machines</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('machine_detail', machine_id=machine.id) }}">{{ machine.name }}</a></li>
    {% if is_edit and maintenance %}
    <li class="breadcrumb-item"><a href="{{ url_for('corrective_maintenance_detail', maintenance_id=maintenance.id) }}">Maintenances corrective</a></li>
    <li class="breadcrumb-item active" aria-current="page">Modifier</li>
    {% else %}
    <li class="breadcrumb-item active" aria-current="page">Maintenances corrective</li>
    {% endif %}
  </ol>
</nav>

<h2>{% if is_edit and maintenance %}Modifier la maintenances corrective{% else %}Maintenances corrective{% endif %}</h2>
<p class="text-muted">Machine : {{ machine.name }} ({{ machine.code }})</p>

<form method="post" class="mt-4" id="correctiveForm" enctype="multipart/form-data">
  <div class="mb-3">
    <label class="form-label">Date et heure</label>
    <input class="form-control" type="datetime-local" name="created_at" id="maintenanceDate" required 
           {% if is_edit and maintenance and maintenance.created_at %}
           value="{{ maintenance.created_at.strftime('%Y-%m-%dT%H:%M') }}"
           {% endif %} />
  </div>

  <div class="mb-3">
    <label class="form-label">Commentaire</label>
    <textarea class="form-control" name="comment" rows="4" placeholder="Décrivez la maintenance corrective effectuée...">{% if is_edit and maintenance and maintenance.comment %}{{ maintenance.comment }}{% endif %}</textarea>
  </div>

  <div class="mb-3">
    <label class="form-label">Nombre d'heures</label>
    <input class="form-control" type="number" step="0.1" min="0" name="hours" 
           value="{% if is_edit and maintenance and maintenance.hours %}{{ maintenance.hours }}{% endif %}" 
           placeholder="Nombre d'heures de la maintenance" />
    <small class="form-text text-muted">Heures au moment de la maintenance</small>
  </div>

  <hr />
  <h4>Sortie de stock <small class="text-muted">(optionnel)</small></h4>
  {% if stocks %}
  <div class="mb-3">
    <label class="form-label">Stock concerné</label>
    <select class="form-select" name="stock_id">
      <option value="">Aucun stock (optionnel)</option>
      {% for stock in stocks %}
      <option value="{{ stock.id }}" {% if (is_edit and maintenance and maintenance.stock_id == stock.id) or (not is_edit and default_stock_id and stock.id == default_stock_id) %}selected{% endif %}>
        {{ stock.name }} ({{ stock.code }})
      </option>
      {% endfor %}
    </select>
  </div>
  <div class="mb-3">
    <label class="form-label">Produits utilisés</label>
    <input class="form-control mb-2" type="text" placeholder="Recherche produit" id="productSearch" />
    <div id="productRows">
      {% if is_edit and maintenance and existing_products %}
        {% for product_id, quantity in existing_products %}
        <div class="row g-2 mb-2 product-row">
          <div class="col-md-6">
            <select class="form-select product-select" name="product_id">
              <option value="">Produit...</option>
              {% for product in products %}
              <option value="{{ product.id }}" data-search="{{ (product.name ~ ' ' ~ product.code)|lower }}"
                      {% if product.id == product_id %}selected{% endif %}>
                {{ product.name }} ({{ product.code }})
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <input class="form-control" type="number" min="1" step="1" name="quantity" placeholder="Quantité" 
                   value="{{ quantity }}" />
          </div>
          <div class="col-md-3">
            <span class="product-quantity-info text-muted small d-block mt-2" style="display: none !important;">
              <span class="product-quantity-value"></span> disponible(s)
            </span>
          </div>
        </div>
        {% endfor %}
      {% else %}
      <div class="row g-2 mb-2 product-row">
        <div class="col-md-6">
          <select class="form-select product-select" name="product_id">
            <option value="">Produit...</option>
            {% for product in products %}
            <option value="{{ product.id }}" data-search="{{ (product.name ~ ' ' ~ product.code)|lower }}">
              {{ product.name }} ({{ product.code }})
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <input class="form-control" type="number" min="1" step="1" name="quantity" placeholder="Quantité" />
        </div>
        <div class="col-md-3">
          <span class="product-quantity-info text-muted small d-block mt-2" style="display: none !important;">
            <span class="product-quantity-value"></span> disponible(s)
          </span>
        </div>
      </div>
      {% endif %}
    </div>
    <button class="btn btn-outline-secondary btn-sm mt-2" type="button" id="addProduct">+ Produit</button>
  </div>
  {% else %}
  <div class="alert alert-info">
    Aucun stock disponible. La sortie de stock est optionnelle.
  </div>
  {% endif %}

  <hr />
  <h4>Photos <small class="text-muted">(optionnel)</small></h4>
  <div class="mb-3">
    <label class="form-label">Ajouter des photos</label>
    <input class="form-control" type="file" name="photos" multiple accept="image/*" />
    <small class="form-text text-muted">Formats acceptés : JPG, PNG, GIF, WEBP. Vous pouvez sélectionner plusieurs photos.</small>
  </div>

  <button class="btn btn-success">{% if is_edit and maintenance %}Modifier la maintenance{% else %}Enregistrer la maintenance{% endif %}</button>
</form>
{% endblock %}
{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const dateInput = document.getElementById("maintenanceDate");
    if (dateInput && !dateInput.value) {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, "0");
      const day = String(now.getDate()).padStart(2, "0");
      const hours = String(now.getHours()).padStart(2, "0");
      const minutes = String(now.getMinutes()).padStart(2, "0");
      dateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    const productRows = document.getElementById("productRows");
    const addProductBtn = document.getElementById("addProduct");
    const productSearch = document.getElementById("productSearch");

    function filterProductOptions(query) {
      if (!productRows) return;
      const selects = productRows.querySelectorAll("select");
      selects.forEach((select) => {
        select.querySelectorAll("option").forEach((option) => {
          if (!option.value) return;
          const searchable = option.dataset.search || option.textContent.toLowerCase();
          option.hidden = query && !searchable.includes(query);
        });
      });
    }

    if (addProductBtn && productRows) {
      addProductBtn.addEventListener("click", () => {
        const template = productRows.querySelector(".product-row");
        if (!template) return;
        const clone = template.cloneNode(true);
        clone.querySelectorAll("select, input").forEach((el) => (el.value = ""));
        productRows.appendChild(clone);
        const query = productSearch ? productSearch.value.trim().toLowerCase() : "";
        filterProductOptions(query);
      });
    }

    if (productSearch) {
      productSearch.addEventListener("input", () => {
        const query = productSearch.value.trim().toLowerCase();
        filterProductOptions(query);
      });
    }

    // Fonction pour mettre à jour la quantité disponible
    function updateProductQuantity(productSelect, quantityInfo) {
      const stockId = document.querySelector('select[name="stock_id"]').value;
      const productId = productSelect.value;
      
      if (!stockId || !productId) {
        quantityInfo.style.display = 'none';
        return;
      }
      
      fetch(`/api/stock/${stockId}/product/${productId}/quantity`)
        .then(response => response.json())
        .then(data => {
          const quantitySpan = quantityInfo.querySelector('.product-quantity-value');
          quantitySpan.textContent = data.quantity;
          quantityInfo.style.display = 'block';
          if (data.quantity === 0) {
            quantityInfo.classList.add('text-danger');
            quantityInfo.classList.remove('text-muted');
          } else {
            quantityInfo.classList.remove('text-danger');
            quantityInfo.classList.add('text-muted');
          }
        })
        .catch(error => {
          console.error('Erreur lors de la récupération de la quantité:', error);
          quantityInfo.style.display = 'none';
        });
    }

    // Écouter les changements de stock
    const stockSelect = document.querySelector('select[name="stock_id"]');
    if (stockSelect) {
      stockSelect.addEventListener('change', () => {
        // Mettre à jour toutes les quantités affichées
        productRows.querySelectorAll('.product-row').forEach(row => {
          const productSelect = row.querySelector('.product-select');
          const quantityInfo = row.querySelector('.product-quantity-info');
          if (productSelect && productSelect.value && quantityInfo) {
            updateProductQuantity(productSelect, quantityInfo);
          } else if (quantityInfo) {
            quantityInfo.style.display = 'none';
          }
        });
      });
    }

    // Écouter les changements de produit dans chaque ligne
    if (productRows) {
      productRows.addEventListener('change', (e) => {
        if (e.target.classList.contains('product-select')) {
          const row = e.target.closest('.product-row');
          const quantityInfo = row.querySelector('.product-quantity-info');
          if (quantityInfo) {
            updateProductQuantity(e.target, quantityInfo);
          }
        }
      });
      
      // Initialiser les quantités pour les produits déjà sélectionnés
      productRows.querySelectorAll('.product-row').forEach(row => {
        const productSelect = row.querySelector('.product-select');
        const quantityInfo = row.querySelector('.product-quantity-info');
        if (productSelect && productSelect.value && quantityInfo) {
          updateProductQuantity(productSelect, quantityInfo);
        }
      });
    }
  });
</script>
{% endblock %}

